---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Terragrunt Plan

on:
  workflow_dispatch:
    inputs:
      path:
        description: Path to run Terragrunt Plan against.
        type: string
        required: true
      commit_sha:
        description: SHA of the head commit to run against.
        type: string
        required: false
        default: ""

jobs:
  plan:
    runs-on: homelab-runner-staging-runner-app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get GitHub App Token
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@v4
        with:
          application_id: ${{ secrets.APPLICATION_ID }}
          application_private_key: ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name: Lookup Check ID
        if: ${{ inputs.commit_sha != '' }}
        id: lookup
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.get_workflow_token.outputs.token }}
          script: |
            const resp = await github.request(
              'GET /repos/{owner}/{repo}/commits/{ref}/check-runs',
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref:   '${{ inputs.commit_sha }}',
                check_name: 'Terragrunt Plan'
              }
            );
            const runs = resp.data.check_runs;
            if (runs.length === 0) throw new Error('No check run found.');
            core.setOutput('check_id', runs[0].id);

      - name: Mark Check in_progress
        if: ${{ steps.lookup.outputs.check_id != '' }}
        uses: LouisBrunner/checks-action@v2
        with:
          token: ${{ steps.get_workflow_token.outputs.token }}
          check_id: ${{ steps.lookup.outputs.check_id }}
          sha: ${{ inputs.commit_sha }}
          status: in_progress
          details_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          output: |
            {
              "title":   "Terragrunt Plan",
              "summary": "Running Terragrunt planâ€¦",
              "text_description": "This check will report the result of the Terragrunt plan."
            }

      - name: Setup Terragrunt and OpenTofu
        uses: ./.github/actions/setup-tf

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terragrunt Plan
        env:
          TG_TF_PATH: tofu
          TERRAGRUNT_NON_INTERACTIVE: true
          TF_INPUT: false
          TF_IN_AUTOMATION: 1
        run: |
          cd ${{ inputs.path }}
          terragrunt plan

      - name: Commit & Push .terraform.lock.hcl
        uses: EndBug/add-and-commit@v9
        with:
          add: ${{ inputs.path }}/.terraform.lock.hcl

      - name: Report Check
        if: ${{ steps.lookup.outputs.check_id  != '' }}
        uses: LouisBrunner/checks-action@v2
        with:
          token: ${{ steps.get_workflow_token.outputs.token }}
          check-id: ${{ steps.lookup.outputs.check_id }}
          sha: ${{ inputs.commit_sha }}
          status: completed
          conclusion: ${{ job.status == 'success' }}
          output: |
            {
              "title":   "Terragrunt Plan Result",
              "summary": "Plan done",
              "text_description": "See the logs for details."
            }
