---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Infrastructure Validate

on:
  pull_request:
    paths:
      - "infrastructure/**"
      - ".github/workflows/infrastructure-validate.yaml"
      - ".mise.toml"
  workflow_dispatch:

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Setup tools
        uses: jdx/mise-action@v2

      - name: Check OpenTofu formatting
        run: tofu fmt -check -recursive -diff infrastructure/

      - name: Check Terragrunt formatting
        working-directory: infrastructure
        run: terragrunt hcl format --check

  test:
    needs: format
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: [aws-set-params, bootstrap, config, talos]
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Setup tools
        uses: jdx/mise-action@v2

      - name: Initialize module
        working-directory: infrastructure/modules/${{ matrix.module }}
        run: tofu init -upgrade

      - name: Run tests
        working-directory: infrastructure/modules/${{ matrix.module }}
        run: tofu test
