---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Terragrunt Init

on:
  workflow_dispatch:
    inputs:
      path:
        description: Path to run against.
        type: string
        required: true
      check_name:
        description: Name of the check to update.
        type: string
        required: false
        default: terragrunt-init
      commit_sha:
        description: SHA of the head commit to run against.
        type: string
        required: true

jobs:
  start-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Check
        id: start-check
        uses: ./.github/actions/update-check
        with:
          application_id: ${{ secrets.APPLICATION_ID }}
          application_private_key: ${{ secrets.APPLICATION_PRIVATE_KEY }}
          commit_sha: ${{ inputs.commit_sha }}
          check_name: ${{ inputs.check_name }}
          status: in_progress
          details_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          output: |
            {
              "title":   "Terragrunt Plan",
              "summary": "Running Terragrunt planâ€¦",
              "text_description": "This check will report the result of the Terragrunt plan."
            }

  terragrunt:
    needs: [start-check]
    runs-on: homelab-runner-staging-runner-app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0

      - name: Setup Terragrunt and OpenTofu
        uses: ./.github/actions/setup-tf

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terragrunt Init
        id: terragrunt
        env:
          TG_TF_PATH: tofu
          TERRAGRUNT_NON_INTERACTIVE: true
          TF_INPUT: false
          TF_IN_AUTOMATION: 1
        run: |
          cd ${{ inputs.path }}
          terragrunt init
        continue-on-error: true

      - name: Commit & Push .terraform.lock.hcl
        uses: EndBug/add-and-commit@v9
        with:
          add: ${{ inputs.path }}/.terraform.lock.hcl

  stop-check:
    needs: [start-check, terragrunt]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stop Check
        if: always()
        id: stop-check
        uses: ./.github/actions/update-check
        with:
          application_id: ${{ secrets.APPLICATION_ID }}
          application_private_key: ${{ secrets.APPLICATION_PRIVATE_KEY }}
          commit_sha: ${{ inputs.commit_sha }}
          check_name: ${{ inputs.check_name }}
          status: completed
          details_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          conclusion: ${{ needs.terragrunt.result }}
          output: |
            {
              "title":   "Terragrunt Init",
              "summary": "Terragrunt Init was: ${{ needs.terragrunt.result }}",
              "text_description": "This check will report the result of the Terragrunt Init."
            }
