---
name: Build Platform Artifact

on:
  push:
    branches: [main]
    paths:
      - "kubernetes/**"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  ARTIFACT_REPO: ${{ github.repository }}/platform
  BASE_VERSION: "0.1.0"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - uses: fluxcd/flux2/action@main

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push artifact
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          SEMVER="${{ env.BASE_VERSION }}-rc.${{ github.run_number }}"

          # Push from repo root so paths match GitRepository structure
          flux push artifact \
            oci://${{ env.REGISTRY }}/${{ env.ARTIFACT_REPO }}:${SEMVER} \
            --path=. \
            --source="https://github.com/${{ github.repository }}" \
            --revision="${{ github.ref_name }}@sha1:${{ github.sha }}"

          flux tag artifact \
            oci://${{ env.REGISTRY }}/${{ env.ARTIFACT_REPO }}:${SEMVER} \
            --tag sha-${SHORT_SHA}

          flux tag artifact \
            oci://${{ env.REGISTRY }}/${{ env.ARTIFACT_REPO }}:${SEMVER} \
            --tag integration-${SHORT_SHA}
