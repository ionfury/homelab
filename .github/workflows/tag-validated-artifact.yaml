---
name: Tag Validated Artifact

on:
  repository_dispatch:
    types: [artifact-validated]
  workflow_dispatch:
    inputs:
      artifact_sha:
        description: "Short SHA to tag as validated (leave empty to auto-detect latest)"
        required: false

env:
  REGISTRY: ghcr.io
  ARTIFACT_REPO: ${{ github.repository }}/platform

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - uses: fluxcd/flux2/action@main

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve artifact SHA and stable semver
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const inputSha = '${{ inputs.artifact_sha }}';
            const payloadSha = '${{ github.event.client_payload.artifact_sha }}';
            const packageName = `${context.repo.repo}/platform`;

            // List all versions of the container package
            const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
              package_type: 'container',
              package_name: packageName,
              username: context.repo.owner,
              per_page: 100,
            });

            // Determine the artifact SHA - from input, payload, or auto-detect latest integration tag
            let sha = inputSha || payloadSha;

            if (!sha) {
              core.info('No SHA provided, discovering latest integration tag...');
              const integrationVersion = versions.data.find(v =>
                v.metadata?.container?.tags?.some(t => t.startsWith('integration-'))
              );
              if (!integrationVersion) {
                core.setFailed('No integration tags found in GHCR');
                return;
              }
              const integrationTag = integrationVersion.metadata.container.tags.find(t =>
                t.startsWith('integration-')
              );
              sha = integrationTag.replace('integration-', '');
              core.info(`Discovered latest integration SHA: ${sha}`);
            }

            // Validate SHA format (7 hex chars)
            if (!/^[a-f0-9]{7}$/.test(sha)) {
              core.setFailed(`Invalid SHA format: ${sha} (expected 7 hex characters)`);
              return;
            }

            // Find the version tagged with integration-<sha> and extract its RC semver tag
            const targetVersion = versions.data.find(v =>
              v.metadata?.container?.tags?.includes(`integration-${sha}`)
            );
            if (!targetVersion) {
              core.setFailed(`Could not find version tagged integration-${sha}`);
              return;
            }

            const rcTag = targetVersion.metadata.container.tags.find(t =>
              /^\d+\.\d+\.\d+-rc\.\d+$/.test(t)
            );
            if (!rcTag) {
              core.setFailed(`No RC semver tag found on version with integration-${sha}`);
              return;
            }

            // Derive stable semver: 0.1.0-rc.130 → 0.1.130
            const match = rcTag.match(/^(\d+\.\d+)\.\d+-rc\.(\d+)$/);
            const stable = `${match[1]}.${match[2]}`;

            core.info(`Found RC tag: ${rcTag}`);
            core.info(`Derived stable semver: ${rcTag} → ${stable}`);
            core.setOutput('sha', sha);
            core.setOutput('stable', stable);

      - name: Tag as validated
        env:
          SHA: ${{ steps.resolve.outputs.sha }}
          STABLE: ${{ steps.resolve.outputs.stable }}
        run: |
          echo "Tagging integration-${SHA} as validated-${SHA} and ${STABLE}"
          flux tag artifact \
            "oci://${{ env.REGISTRY }}/${{ env.ARTIFACT_REPO }}:integration-${SHA}" \
            --tag "validated-${SHA}"
          flux tag artifact \
            "oci://${{ env.REGISTRY }}/${{ env.ARTIFACT_REPO }}:integration-${SHA}" \
            --tag "${STABLE}"
