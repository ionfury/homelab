---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Kubernetes Validate

on:
  pull_request:
    paths:
      - "kubernetes/**"
      - ".github/workflows/kubernetes-validate.yaml"
      - ".yamllint.yaml"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint --strict kubernetes/
          yamllint --strict .github/workflows/

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2.1.0
        with:
          kustomize-version: "5.4.1"

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Install yq
        run: |
          curl -sSL https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -o yq
          chmod +x yq
          sudo mv yq /usr/local/bin/

      - name: Build kustomizations
        run: |
          mkdir -p /tmp/manifests

          # Find and build each kustomization
          find kubernetes/platform/config -name "kustomization.yaml" -exec dirname {} \; | while read -r dir; do
            name=$(echo "$dir" | sed 's|kubernetes/platform/config/||; s|/|-|g')
            echo "Building kustomization: $dir"
            kustomize build "$dir" > "/tmp/manifests/${name}.yaml"
          done

      - name: Substitute Flux variables
        run: |
          # Export variables from dev cluster config
          set -a
          # shellcheck source=/dev/null
          source kubernetes/clusters/dev/.cluster-vars.env
          set +a

          # Substitute variables in all manifests
          for manifest in /tmp/manifests/*.yaml; do
            envsubst < "$manifest" > "${manifest}.tmp"
            mv "${manifest}.tmp" "$manifest"
          done

          # Fix StorageClass parameters to be strings (envsubst produces unquoted numbers)
          for manifest in /tmp/manifests/*.yaml; do
            yq -i '(select(.kind == "StorageClass") | .parameters.numberOfReplicas) |= . tag = "!!str"' "$manifest"
          done

      - name: Validate schemas with kubeconform
        run: |
          kubeconform \
            -schema-location default \
            -schema-location 'https://kubernetes-schemas.pages.dev/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip ResourceSet \
            -ignore-missing-schemas \
            -summary \
            -output text \
            /tmp/manifests/*.yaml
