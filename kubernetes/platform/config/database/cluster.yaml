---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: platform
spec:
  description: "Shared platform PostgreSQL cluster"
  imageName: ghcr.io/cloudnative-pg/postgresql:17.2
  instances: ${default_replica_count}
  primaryUpdateStrategy: unsupervised

  superuserSecret:
    name: cnpg-platform-superuser

  postgresql:
    parameters:
      shared_buffers: "256MB"
      max_connections: "200"
      effective_cache_size: "512MB"
      log_statement: "ddl"
      log_min_duration_statement: "1000"
    pg_hba:
      - host all all 10.0.0.0/8 scram-sha-256
      - host all all 172.16.0.0/12 scram-sha-256

  storage:
    storageClass: fast
    size: ${database_volume_size}

  # S3 backup via Barman - enables continuous WAL archiving and scheduled base backups
  backup:
    barmanObjectStore:
      destinationPath: "s3://homelab-cnpg-backup-${cluster_name}@us-east-2/"
      s3Credentials:
        accessKeyId:
          name: cnpg-s3-backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: cnpg-s3-backup-credentials
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
        maxParallel: 4
      retentionPolicy: "30d"

  # Recovery source for disaster recovery - CNPG uses this on cluster creation
  # to restore from the latest backup if one exists in S3
  externalClusters:
    - name: backup-source
      barmanObjectStore:
        destinationPath: "s3://homelab-cnpg-backup-${cluster_name}@us-east-2/"
        s3Credentials:
          accessKeyId:
            name: cnpg-s3-backup-credentials
            key: ACCESS_KEY_ID
          secretAccessKey:
            name: cnpg-s3-backup-credentials
            key: ACCESS_SECRET_KEY
        wal:
          maxParallel: 4

  # Bootstrap from recovery - restores from latest backup on cluster creation.
  # If no backup exists, CNPG initializes a fresh database instead.
  bootstrap:
    recovery:
      source: backup-source

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 2Gi

  monitoring:
    enablePodMonitor: true

  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
