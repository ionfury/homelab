---
apiVersion: dragonflydb.io/v1alpha1
kind: Dragonfly
metadata:
  name: dragonfly
spec:
  replicas: ${default_replica_count}

  authentication:
    passwordFromSecret:
      name: dragonfly-password
      key: password

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 1Gi

  args:
    - "--maxmemory"
    - "768mb"
    - "--cache_mode"
    - "--proactor_threads"
    - "2"
    - "--dbfilename"
    - "dump"
    - "--s3_endpoint"
    - "garage.garage.svc.cluster.local:3900"
    - "--s3_use_https=false"

  env:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: dragonfly-s3-credentials
          key: access-key-id
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: dragonfly-s3-credentials
          key: secret-access-key
    - name: AWS_REGION
      value: "garage"

  snapshot:
    cron: "0 */6 * * *"
    dir: "s3://dragonfly-snapshots/"
    persistentVolumeClaimSpec:
      accessModes:
        - ReadWriteOnce
      storageClassName: fast
      resources:
        requests:
          storage: ${dragonfly_volume_size:-1Gi}

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app: dragonfly
          app.kubernetes.io/name: dragonfly
