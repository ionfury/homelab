---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: coraza-waf
  labels:
    prometheus: kube-prometheus-stack
    release: kube-prometheus-stack
spec:
  groups:
    - name: coraza-waf
      rules:
        # Alert if WAF metrics disappear (indicates WAF not processing traffic)
        - alert: CorazaWAFDegraded
          expr: |
            absent(waf_filter_tx_total{pod=~"external-.*"}) == 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Coraza WAF is degraded on external gateway"
            description: "WAF metrics are absent. The WAF filter may not be loaded or processing traffic."

        # Alert on sustained high block rate (potential attack or false positives)
        - alert: CorazaWAFHighBlockRate
          expr: |
            (
              sum(rate(waf_filter_tx_interruptions{pod=~"external-.*"}[5m]))
              / sum(rate(waf_filter_tx_total{pod=~"external-.*"}[5m]))
            ) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Coraza WAF blocking >10% of traffic"
            description: "High block rate may indicate attack or false positives. Review waf_rule_hits_total for top triggered rules."

        # Alert if gateway latency is impacting user experience
        - alert: CorazaWAFHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(istio_request_duration_milliseconds_bucket{destination_workload=~"external-.*", reporter="destination"}[5m])) by (le)
            ) > 50
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "External gateway p99 latency >50ms"
            description: "Gateway processing overhead is high. Consider rule optimization or increasing paranoia level exclusions."
