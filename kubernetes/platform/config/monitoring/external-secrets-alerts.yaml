---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: external-secrets-alerts
  labels:
    app.kubernetes.io/name: external-secrets
spec:
  groups:
    - name: external-secrets.rules
      rules:
        - alert: ExternalSecretSyncFailure
          expr: |
            increase(externalsecret_sync_calls_error[5m]) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ExternalSecret sync failure for {{ $labels.name }} in {{ $labels.namespace }}"
            description: >-
              ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} is failing to sync
              from the secret provider. This can cause deployments to fail or use stale secrets.
              Check the external-secrets-operator logs and verify the secret store connectivity.

        - alert: ExternalSecretNotReady
          expr: |
            externalsecret_status_condition{condition="Ready",status="False"} == 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "ExternalSecret {{ $labels.name }} not ready in {{ $labels.namespace }}"
            description: >-
              ExternalSecret {{ $labels.namespace }}/{{ $labels.name }} has been in a non-ready
              state for more than 10 minutes. Check the ExternalSecret status and events
              for details on the failure reason.

        - alert: ClusterSecretStoreUnhealthy
          expr: |
            clustersecretstore_status_condition{condition="Ready",status="False"} == 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ClusterSecretStore {{ $labels.name }} is unhealthy"
            description: >-
              ClusterSecretStore {{ $labels.name }} is not ready. This affects all ExternalSecrets
              using this store. Verify credentials and connectivity to the secret provider (AWS SSM).
