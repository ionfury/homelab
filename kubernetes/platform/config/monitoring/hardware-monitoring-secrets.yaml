---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hardware-monitoring-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-ssm
  target:
    name: hardware-monitoring-credentials
    template:
      engineVersion: v2
      data:
        snmp-community: "{{ .snmpCommunity }}"
        ipmi-username: "{{ .ipmiUsername }}"
        ipmi-password: "{{ .ipmiPassword }}"
        # IPMI exporter config referencing templated credentials
        ipmi-config.yml: |
          modules:
            default:
              user: "{{ .ipmiUsername }}"
              pass: "{{ .ipmiPassword }}"
              driver: "LAN_2_0"
              privilege: "admin"
              timeout: 10000
              collectors:
                - bmc
                - ipmi
                - chassis
                - sel
  data:
    - secretKey: snmpCommunity
      remoteRef:
        key: /homelab/kubernetes/${cluster_name}/snmp-community
    - secretKey: ipmiUsername
      remoteRef:
        key: /homelab/kubernetes/${cluster_name}/ipmi-username
    - secretKey: ipmiPassword
      remoteRef:
        key: /homelab/kubernetes/${cluster_name}/ipmi-password
