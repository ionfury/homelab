---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/values.schema.json
# https://github.com/bjw-s/helm-charts/tree/main/charts/other/app-template
controllers:
  garage:
    type: statefulset
    replicas: ${default_replica_count}
    annotations:
      reloader.stakater.com/auto: "true"

    pod:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

    containers:
      app:
        image:
          repository: dxflrs/garage
          tag: v2.1.0
        env:
          TZ: UTC
          GARAGE_RPC_SECRET:
            valueFrom:
              secretKeyRef:
                name: garage-secret
                key: rpc-secret
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: [ALL]
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 1Gi
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 3903
              initialDelaySeconds: 15
              periodSeconds: 30
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 3903
              initialDelaySeconds: 5
              periodSeconds: 10

service:
  app:
    controller: garage
    ports:
      s3:
        port: 3900
      rpc:
        port: 3901
      admin:
        port: 3903

ingress:
  app:
    enabled: true
    className: internal
    hosts:
      - host: s3.${internal_domain}
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: s3
      - host: "*.s3.${internal_domain}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: s3
    tls:
      - hosts:
          - s3.${internal_domain}
          - "*.s3.${internal_domain}"

serviceMonitor:
  app:
    serviceName: garage-app
    enabled: true
    endpoints:
      - port: admin
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 30s

persistence:
  config:
    enabled: true
    type: configMap
    name: garage-config
    globalMounts:
      - path: /etc/garage.toml
        subPath: garage.toml
        readOnly: true
  meta:
    enabled: true
    type: persistentVolumeClaim
    storageClass: fast
    accessMode: ReadWriteOnce
    size: ${garage_meta_volume_size}
    globalMounts:
      - path: /var/lib/garage/meta
  data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: fast
    accessMode: ReadWriteOnce
    size: ${garage_data_volume_size}
    globalMounts:
      - path: /var/lib/garage/data
