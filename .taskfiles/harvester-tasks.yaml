version: "3"

vars:
  RANCHER_SERVER_URL: "https://rancher.tomnowak.work" # https://us-east-2.console.aws.amazon.com/systems-manager/parameters/rancher-admin-url
  RANCHER_ADMIN_TOKEN: "<RANCHER_ADMIN_TOKEN>" # https://us-east-2.console.aws.amazon.com/systems-manager/parameters/rancher-admin-token/
  HARVESTER_CLUSTER_ID: "c-m-z5w2pxgh" # https://rancher.tomnowak.work/dashboard/c/_/harvesterManager/harvesterhci.io.management.cluster
  CLOUD_PROVIDER_NAME: harvester-cloud-provider
  CLOUD_PROVIDER_KUBECONFIG_PATH: "~/.kube/{{.CLOUD_PROVIDER_NAME}}-kubeconfig.yaml"

tasks:
  # https://registry.terraform.io/providers/rancher/rancher2/latest/docs/resources/cluster_v2#creating-rancher-v2-harvester-cluster-v2-with-harvester-cloud-provider
  get-cloud-provider-kubeconfig:
    desc: |
      Retrieve the harvester cloud provider kubeconfig from the Rancher cluster.
      Expected usage: `task:get-cloud-provider-kubeconfig RANCHER_ADMIN_TOKEN=$VAR`
    cmds:
      - |
        curl -k -X POST {{.RANCHER_SERVER_URL}}/k8s/clusters/{{.HARVESTER_CLUSTER_ID}}/v1/harvester/kubeconfig \
          -H 'Content-Typecation/json' \
          -H "Authorization: Bearer {{.RANCHER_ADMIN_TOKEN}}" \
          -d '{"clusterRoleName": "harvesterhci.io:cloudprovider", "namespace": "default", "serviceAccountName": "'{{.CLOUD_PROVIDER_NAME}}'"}' | xargs | sed 's/\\n/\n/g' > {{.CLOUD_PROVIDER_KUBECONFIG_PATH}}
