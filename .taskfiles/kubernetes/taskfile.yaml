---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]

vars:
  CHARTS_DIR: "{{.ROOT_DIR}}/kubernetes/platform/charts"
  HELM_CHARTS_FILE: "{{.ROOT_DIR}}/kubernetes/platform/helm-charts.yaml"
  CLUSTERS_DIR: "{{.ROOT_DIR}}/kubernetes/clusters"
  VERSION_VARS: "{{.ROOT_DIR}}/kubernetes/platform/versions.env"
  MANIFESTS_DIR: "/tmp/homelab-manifests"
  PLATFORM_DIR: "{{.ROOT_DIR}}/kubernetes/platform"
  RESOURCESETS: "namespaces.yaml helm-charts.yaml config.yaml"
  STATIC_PROVIDER: "{{.PLATFORM_DIR}}/.static-provider.yaml"
  EXPANDED_DIR: "/tmp/homelab-expanded"
  DEV_KUBECONFIG: "~/.kube/dev.yaml"
  # Test variables for Flux substitution (used by helm templating)
  TEST_CLUSTER_NAME: ci-test
  TEST_POD_SUBNET: "10.244.0.0/16"
  TEST_INTERNAL_DOMAIN: internal.ci.example.com
  TEST_EXTERNAL_DOMAIN: external.ci.example.com
  TEST_REPLICA_COUNT: "1"
  TEST_GARAGE_DATA_SIZE: "10Gi"
  TEST_GARAGE_META_SIZE: "1Gi"
  TEST_LOKI_SIZE: "10Gi"
  TEST_PROMETHEUS_SIZE: "10Gi"
  # Common kubeconform arguments (double-brace escaping for kubeconform templates)
  KUBECONFORM_ARGS: >-
    -schema-location default
    -schema-location 'https://kubernetes-schemas.pages.dev/{{ "{{.Group}}" }}/{{ "{{.ResourceKind}}" }}_{{ "{{.ResourceAPIVersion}}" }}.json'
    -ignore-missing-schemas
    -summary
    -output text

tasks:
  # =============================================================================
  # User-Facing Tasks
  # =============================================================================

  validate:
    desc: Cluster-independent validation (lint, ResourceSets, Helm charts, base kubeconform)
    cmds:
      - task: _lint
      - task: _expand-resourcesets
      - task: _build-manifests
      - task: _template-all-charts
      - task: _validate-kubeconform-base

  validate-*:
    desc: Validate manifests for a specific cluster
    vars:
      CLUSTER: "{{index .MATCH 0}}"
      CLUSTER_VARS: "{{.CLUSTERS_DIR}}/{{.CLUSTER}}/.cluster-vars.env"
      CLUSTER_OUTPUT_DIR: "{{.EXPANDED_DIR}}/clusters/{{.CLUSTER}}"
    label: validate-{{.CLUSTER}}
    deps: [_build-manifests, _expand-resourcesets]
    cmds:
      - task: _substitute-vars-cluster
        vars:
          CLUSTER: "{{.CLUSTER}}"
          CLUSTER_VARS: "{{.CLUSTER_VARS}}"
          CLUSTER_OUTPUT_DIR: "{{.CLUSTER_OUTPUT_DIR}}"
      - task: _validate-kubeconform-cluster
        vars:
          CLUSTER: "{{.CLUSTER}}"
          CLUSTER_OUTPUT_DIR: "{{.CLUSTER_OUTPUT_DIR}}"
    preconditions:
      - sh: test -d "{{.CLUSTERS_DIR}}/{{.CLUSTER}}"
        msg: "Cluster '{{.CLUSTER}}' does not exist in {{.CLUSTERS_DIR}}"
      - sh: test -f "{{.CLUSTER_VARS}}"
        msg: "Cluster '{{.CLUSTER}}' has no .cluster-vars.env file"

  validate-all:
    desc: Full validation (cluster-independent + all discovered clusters)
    cmds:
      - task: validate
      - task: _validate-all-clusters

  list-clusters:
    desc: List clusters with .cluster-vars.env files (JSON for CI)
    silent: true
    cmds:
      - |
        find "{{.CLUSTERS_DIR}}" -name ".cluster-vars.env" -exec dirname {} \; 2>/dev/null | \
          xargs -I{} basename {} | \
          sort | \
          jq -R -s -c 'split("\n") | map(select(. != ""))'

  dry-run-dev:
    desc: Server-side dry-run against dev cluster
    deps: [validate]
    cmds:
      - |
        echo "Running server-side dry-run against dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Dry-run: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply --dry-run=server -f "$manifest"
        done
        echo ""
        echo "Server-side dry-run completed successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  apply-dev:
    desc: Apply manifests to dev cluster (REQUIRES CONFIRMATION)
    deps: [validate]
    prompt: This will apply manifests to the dev cluster. Continue?
    cmds:
      - |
        echo "Applying to dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Applying: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply -f "$manifest"
        done
        echo ""
        echo "Applied to dev cluster successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  # =============================================================================
  # Internal Tasks
  # =============================================================================

  _lint:
    internal: true
    cmds:
      - yamllint --strict kubernetes/
      - yamllint --strict .github/workflows/
    preconditions:
      - which yamllint

  _build-manifests:
    internal: true
    env:
      MANIFESTS_DIR: "{{.MANIFESTS_DIR}}"
      PLATFORM_DIR: "{{.PLATFORM_DIR}}"
    cmds:
      - rm -rf {{.MANIFESTS_DIR}} && mkdir -p {{.MANIFESTS_DIR}}
      - "{{.TASKFILE_DIR}}/scripts/build-manifests.sh"
    preconditions:
      - which kustomize

  _expand-resourcesets:
    internal: true
    cmds:
      - rm -rf {{.EXPANDED_DIR}}/resourcesets && mkdir -p {{.EXPANDED_DIR}}/resourcesets
      - |
        for rset in {{.RESOURCESETS}}; do
          echo "Expanding ResourceSet: $rset"
          flux-operator build rset \
            -f "{{.PLATFORM_DIR}}/$rset" \
            --inputs-from-provider "{{.STATIC_PROVIDER}}" \
            > "{{.EXPANDED_DIR}}/resourcesets/${rset}"
        done
    preconditions:
      - which flux-operator
      - test -f {{.STATIC_PROVIDER}}

  _template-all-charts:
    internal: true
    deps: [_expand-resourcesets]
    env:
      CHARTS_DIR: "{{.CHARTS_DIR}}"
      HELM_CHARTS_FILE: "{{.HELM_CHARTS_FILE}}"
      VERSION_VARS: "{{.VERSION_VARS}}"
      EXPANDED_DIR: "{{.EXPANDED_DIR}}"
      cluster_name: "{{.TEST_CLUSTER_NAME}}"
      cluster_pod_subnet: "{{.TEST_POD_SUBNET}}"
      internal_domain: "{{.TEST_INTERNAL_DOMAIN}}"
      external_domain: "{{.TEST_EXTERNAL_DOMAIN}}"
      default_replica_count: "{{.TEST_REPLICA_COUNT}}"
      garage_data_volume_size: "{{.TEST_GARAGE_DATA_SIZE}}"
      garage_meta_volume_size: "{{.TEST_GARAGE_META_SIZE}}"
      loki_volume_size: "{{.TEST_LOKI_SIZE}}"
      prometheus_volume_size: "{{.TEST_PROMETHEUS_SIZE}}"
    cmds:
      - mkdir -p {{.EXPANDED_DIR}}/helm
      - "{{.TASKFILE_DIR}}/scripts/template-all-charts.sh"
    preconditions:
      - which helm yq jq envsubst

  _substitute-vars-cluster:
    internal: true
    desc: Substitute variables for a specific cluster
    requires:
      vars: [CLUSTER, CLUSTER_VARS, CLUSTER_OUTPUT_DIR]
    env:
      VERSION_VARS: "{{.VERSION_VARS}}"
    cmds:
      - mkdir -p "{{.CLUSTER_OUTPUT_DIR}}/manifests" "{{.CLUSTER_OUTPUT_DIR}}/resourcesets"
      - |
        echo "Substituting vars for cluster: {{.CLUSTER}}"
        set -a && source "{{.CLUSTER_VARS}}" && source "{{.VERSION_VARS}}" && set +a

        # Substitute in kustomize manifests
        for manifest in {{.MANIFESTS_DIR}}/*.yaml; do
          [ -f "$manifest" ] || continue
          outfile="{{.CLUSTER_OUTPUT_DIR}}/manifests/$(basename "$manifest")"
          perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
            my $var = $1; my $default = $2; my $val = $ENV{$var};
            defined($val) && $val ne "" ? $val : $default;
          /gex' "$manifest" | envsubst > "$outfile"
        done

        # Substitute in ResourceSets
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          [ -f "$manifest" ] || continue
          outfile="{{.CLUSTER_OUTPUT_DIR}}/resourcesets/$(basename "$manifest")"
          perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
            my $var = $1; my $default = $2; my $val = $ENV{$var};
            defined($val) && $val ne "" ? $val : $default;
          /gex' "$manifest" | envsubst > "$outfile"
        done
      # Fix StorageClass parameters to be strings
      - |
        for manifest in {{.CLUSTER_OUTPUT_DIR}}/manifests/*.yaml; do
          [ -f "$manifest" ] || continue
          yq -i '(select(.kind == "StorageClass") | .parameters.numberOfReplicas) |= . tag = "!!str"' "$manifest"
        done
    preconditions:
      - which envsubst yq perl
      - test -f "{{.CLUSTER_VARS}}"
      - test -d "{{.MANIFESTS_DIR}}"
      - test -d "{{.EXPANDED_DIR}}/resourcesets"

  _validate-kubeconform-base:
    internal: true
    desc: Validate non-cluster-specific outputs (Helm charts, ResourceSets with defaults)
    deps: [_template-all-charts, _expand-resourcesets]
    cmds:
      # Skip Kustomization in ResourceSets - they contain ${source_kind} which is cluster-specific
      # Full Kustomization validation happens in validate-* with proper cluster vars
      - echo "Validating expanded ResourceSets (skipping Kustomizations with cluster-specific vars)..."
      - kubeconform {{.KUBECONFORM_ARGS}} -skip Kustomization {{.EXPANDED_DIR}}/resourcesets/*.yaml
      - echo ""
      - echo "Validating templated Helm charts..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.EXPANDED_DIR}}/helm/*.yaml
    preconditions:
      - which kubeconform
      - test -d {{.EXPANDED_DIR}}/resourcesets
      - test -d {{.EXPANDED_DIR}}/helm

  _validate-kubeconform-cluster:
    internal: true
    desc: Validate cluster-substituted manifests
    requires:
      vars: [CLUSTER, CLUSTER_OUTPUT_DIR]
    cmds:
      - echo "Validating substituted manifests for cluster {{.CLUSTER}}..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.CLUSTER_OUTPUT_DIR}}/resourcesets/*.yaml
      - echo ""
      - kubeconform {{.KUBECONFORM_ARGS}} -skip ResourceSet {{.CLUSTER_OUTPUT_DIR}}/manifests/*.yaml
    preconditions:
      - which kubeconform
      - test -d "{{.CLUSTER_OUTPUT_DIR}}/resourcesets"
      - test -d "{{.CLUSTER_OUTPUT_DIR}}/manifests"

  _validate-all-clusters:
    internal: true
    desc: Validate all discovered clusters
    vars:
      CLUSTERS:
        sh: find "{{.CLUSTERS_DIR}}" -name ".cluster-vars.env" -exec dirname {} \; 2>/dev/null | xargs -I{} basename {} | sort || true
    cmds:
      - |
        if [ -z "{{.CLUSTERS}}" ]; then
          echo "No clusters with .cluster-vars.env found - skipping cluster-specific validation"
          exit 0
        fi
      - for: {var: CLUSTERS}
        task: validate-{{.ITEM}}
