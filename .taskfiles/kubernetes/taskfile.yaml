---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]

vars:
  CHARTS_DIR: "{{.ROOT_DIR}}/kubernetes/platform/charts"
  HELM_CHARTS_FILE: "{{.ROOT_DIR}}/kubernetes/platform/helm-charts.yaml"
  CLUSTERS_DIR: "{{.ROOT_DIR}}/kubernetes/clusters"
  VERSION_VARS: "{{.ROOT_DIR}}/kubernetes/platform/versions.env"
  MANIFESTS_DIR: "/tmp/homelab-manifests"
  PLATFORM_DIR: "{{.ROOT_DIR}}/kubernetes/platform"
  RESOURCESETS: "namespaces.yaml helm-charts.yaml config.yaml"
  STATIC_PROVIDER: "{{.PLATFORM_DIR}}/.static-provider.yaml"
  EXPANDED_DIR: "/tmp/homelab-expanded"
  DEV_KUBECONFIG: "~/.kube/dev.yaml"
  # Test variables for Flux substitution (used by helm templating)
  TEST_CLUSTER_NAME: ci-test
  TEST_POD_SUBNET: "10.244.0.0/16"
  TEST_INTERNAL_DOMAIN: internal.ci.example.com
  TEST_EXTERNAL_DOMAIN: external.ci.example.com
  TEST_REPLICA_COUNT: "1"
  TEST_GARAGE_DATA_SIZE: "10Gi"
  TEST_GARAGE_META_SIZE: "1Gi"
  TEST_LOKI_SIZE: "10Gi"
  TEST_PROMETHEUS_SIZE: "10Gi"

tasks:
  # =============================================================================
  # User-Facing Tasks
  # =============================================================================

  validate:
    desc: Full Kubernetes validation (lint, ResourceSets, all charts, kubeconform)
    cmds:
      - task: _lint
      - task: _expand-resourcesets
      - task: _build-manifests
      - task: _substitute-vars
      - task: _template-all-charts
      - task: _validate-kubeconform

  dry-run-dev:
    desc: Server-side dry-run against dev cluster
    deps: [validate]
    cmds:
      - |
        echo "Running server-side dry-run against dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Dry-run: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply --dry-run=server -f "$manifest"
        done
        echo ""
        echo "Server-side dry-run completed successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  apply-dev:
    desc: Apply manifests to dev cluster (REQUIRES CONFIRMATION)
    deps: [validate]
    prompt: This will apply manifests to the dev cluster. Continue?
    cmds:
      - |
        echo "Applying to dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Applying: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply -f "$manifest"
        done
        echo ""
        echo "Applied to dev cluster successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  # =============================================================================
  # Internal Tasks (hidden from task --list)
  # =============================================================================

  _lint:
    internal: true
    cmds:
      - yamllint --strict kubernetes/
      - yamllint --strict .github/workflows/
    preconditions:
      - which yamllint

  _build-manifests:
    internal: true
    env:
      MANIFESTS_DIR: "{{.MANIFESTS_DIR}}"
      PLATFORM_DIR: "{{.PLATFORM_DIR}}"
    cmds:
      - rm -rf {{.MANIFESTS_DIR}} && mkdir -p {{.MANIFESTS_DIR}}
      - "{{.TASKFILE_DIR}}/scripts/build-manifests.sh"
    preconditions:
      - which kustomize

  _substitute-vars:
    internal: true
    deps: [_build-manifests, _expand-resourcesets]
    desc: Substitute variables in manifests for each available cluster (or use defaults if none)
    env:
      VERSION_VARS: "{{.VERSION_VARS}}"
      MANIFESTS_DIR: "{{.MANIFESTS_DIR}}"
      CLUSTERS_DIR: "{{.CLUSTERS_DIR}}"
      EXPANDED_DIR: "{{.EXPANDED_DIR}}"
    cmds:
      # Detect available clusters and substitute vars for each
      # If no clusters have vars, just apply version defaults
      - |
        CLUSTER_VARS_FILES=$(find "{{.CLUSTERS_DIR}}" -name ".cluster-vars.env" 2>/dev/null || true)

        if [ -z "$CLUSTER_VARS_FILES" ]; then
          echo "No cluster vars found - using version defaults only"
          # Apply only VERSION_VARS (${var:-default} patterns use defaults)
          set -a && source "{{.VERSION_VARS}}" && set +a

          # Substitute in kustomize manifests
          for manifest in {{.MANIFESTS_DIR}}/*.yaml; do
            [ -f "$manifest" ] || continue
            perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
              my $var = $1; my $default = $2; my $val = $ENV{$var};
              defined($val) && $val ne "" ? $val : $default;
            /gex' "$manifest" | envsubst > "${manifest}.tmp"
            mv "${manifest}.tmp" "$manifest"
          done

          # Substitute in ResourceSets
          for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
            [ -f "$manifest" ] || continue
            perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
              my $var = $1; my $default = $2; my $val = $ENV{$var};
              defined($val) && $val ne "" ? $val : $default;
            /gex' "$manifest" | envsubst > "${manifest}.tmp"
            mv "${manifest}.tmp" "$manifest"
          done
        else
          echo "Found cluster vars:"
          echo "$CLUSTER_VARS_FILES" | while read -r f; do echo "  - $f"; done
          echo ""

          # Validate with each cluster's vars (validates manifests work for all clusters)
          for CLUSTER_VARS in $CLUSTER_VARS_FILES; do
            CLUSTER_NAME=$(dirname "$CLUSTER_VARS" | xargs basename)
            echo "Substituting vars for cluster: $CLUSTER_NAME"

            set -a && source "$CLUSTER_VARS" && source "{{.VERSION_VARS}}" && set +a

            # Substitute in kustomize manifests
            for manifest in {{.MANIFESTS_DIR}}/*.yaml; do
              [ -f "$manifest" ] || continue
              perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
                my $var = $1; my $default = $2; my $val = $ENV{$var};
                defined($val) && $val ne "" ? $val : $default;
              /gex' "$manifest" | envsubst > "${manifest}.tmp"
              mv "${manifest}.tmp" "$manifest"
            done

            # Substitute in ResourceSets
            for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
              [ -f "$manifest" ] || continue
              perl -pe 's/\$\{([a-zA-Z_][a-zA-Z0-9_]*):-([^}]*)\}/
                my $var = $1; my $default = $2; my $val = $ENV{$var};
                defined($val) && $val ne "" ? $val : $default;
              /gex' "$manifest" | envsubst > "${manifest}.tmp"
              mv "${manifest}.tmp" "$manifest"
            done

            # Only need to validate with one cluster's vars (they should all produce valid YAML)
            break
          done
        fi
      # Fix StorageClass parameters to be strings (envsubst produces unquoted numbers)
      - |
        for manifest in {{.MANIFESTS_DIR}}/*.yaml; do
          [ -f "$manifest" ] || continue
          yq -i '(select(.kind == "StorageClass") | .parameters.numberOfReplicas) |= . tag = "!!str"' "$manifest"
        done
    preconditions:
      - which envsubst yq

  _expand-resourcesets:
    internal: true
    cmds:
      - rm -rf {{.EXPANDED_DIR}}/resourcesets && mkdir -p {{.EXPANDED_DIR}}/resourcesets
      - |
        for rset in {{.RESOURCESETS}}; do
          echo "Expanding ResourceSet: $rset"
          flux-operator build rset \
            -f "{{.PLATFORM_DIR}}/$rset" \
            --inputs-from-provider "{{.STATIC_PROVIDER}}" \
            > "{{.EXPANDED_DIR}}/resourcesets/${rset}"
        done
    preconditions:
      - which flux-operator
      - test -f {{.STATIC_PROVIDER}}

  _template-all-charts:
    internal: true
    deps: [_expand-resourcesets]
    env:
      CHARTS_DIR: "{{.CHARTS_DIR}}"
      HELM_CHARTS_FILE: "{{.HELM_CHARTS_FILE}}"
      VERSION_VARS: "{{.VERSION_VARS}}"
      EXPANDED_DIR: "{{.EXPANDED_DIR}}"
      cluster_name: "{{.TEST_CLUSTER_NAME}}"
      cluster_pod_subnet: "{{.TEST_POD_SUBNET}}"
      internal_domain: "{{.TEST_INTERNAL_DOMAIN}}"
      external_domain: "{{.TEST_EXTERNAL_DOMAIN}}"
      default_replica_count: "{{.TEST_REPLICA_COUNT}}"
      garage_data_volume_size: "{{.TEST_GARAGE_DATA_SIZE}}"
      garage_meta_volume_size: "{{.TEST_GARAGE_META_SIZE}}"
      loki_volume_size: "{{.TEST_LOKI_SIZE}}"
      prometheus_volume_size: "{{.TEST_PROMETHEUS_SIZE}}"
    cmds:
      - mkdir -p {{.EXPANDED_DIR}}/helm
      - "{{.TASKFILE_DIR}}/scripts/template-all-charts.sh"
    preconditions:
      - which helm yq jq envsubst

  _validate-kubeconform:
    internal: true
    deps: [_template-all-charts, _substitute-vars]
    vars:
      KUBECONFORM_ARGS: >-
        -schema-location default
        -schema-location 'https://kubernetes-schemas.pages.dev/{{ "{{.Group}}" }}/{{ "{{.ResourceKind}}" }}_{{ "{{.ResourceAPIVersion}}" }}.json'
        -ignore-missing-schemas
        -summary
        -output text
    cmds:
      - echo "Validating expanded ResourceSets..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.EXPANDED_DIR}}/resourcesets/*.yaml
      - echo ""
      - echo "Validating templated Helm charts..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.EXPANDED_DIR}}/helm/*.yaml
      - echo ""
      - echo "Validating kustomize manifests..."
      - kubeconform {{.KUBECONFORM_ARGS}} -skip ResourceSet {{.MANIFESTS_DIR}}/*.yaml
    preconditions:
      - which kubeconform
      - test -d {{.EXPANDED_DIR}}/resourcesets
      - test -d {{.EXPANDED_DIR}}/helm
