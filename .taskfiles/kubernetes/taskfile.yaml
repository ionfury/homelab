---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CLUSTER_DIR: "{{.ROOT_DIR}}/kubernetes/clusters"
  MANIFESTS_DIR: "{{.ROOT_DIR}}/kubernetes/manifests"
  KUBERNETES_RESOURCES_DIR: "{{.ROOT_DIR}}/.taskfiles/kubernetes/resources"

tasks:
  get-kubeconfig-*:
    desc: Get Kubeconfig from AWS
    dotenv: ["{{.KUBERNETES_RESOURCES_DIR}}/.env"]
    vars:
      NAME: "{{ index .MATCH 0 }}"
    cmds:
      - mkdir -p tmpdir/
      - defer: rm -rf tmpdir/
      - aws ssm get-parameter --name /homelab/infrastructure/clusters/{{.NAME}}/kubeconfig --with-decryption --query "Parameter.Value" --output text > tmpdir/config
      - KUBECONFIG="tmpdir/config:$HOME/.kube/config" kubectl config view --flatten --merge > tmpdir/merged
      - mv tmpdir/merged ~/.kube/config

  delete-terminated-pods:
    desc: Deleted all Error and Completed status pods
    cmds:
      - |
        kubectl get pods --all-namespaces -o json | \
        jq -r '.items[] | select(.status.phase=="Succeeded" or .status.containerStatuses[]?.state.terminated?.reason=="Error") | "\(.metadata.namespace) \(.metadata.name)"' | \
        xargs -n2 sh -c 'kubectl delete pod -n "$0" "$1"'

  diff:
    desc: Show diff of rendered Kubernetes manifests between current branch and main
    silent: false
    vars:
      CLUSTERS:
        sh: "ls -1 {{.CLUSTER_DIR}}"
      CURRENT_BRANCH:
        sh: "git rev-parse --abbrev-ref HEAD"
      CURRENT_RENDERED: "{{.ROOT_DIR}}/.rendered/current"
      MAIN_RENDERED: "{{.ROOT_DIR}}/.rendered/main"
    cmds:
      - defer: rm -rf {{.CURRENT_RENDERED}} {{.MAIN_RENDERED}}
      # Render current branch (HEAD)
      - mkdir -p {{.CURRENT_RENDERED}}
      - task: render-clusters-to-dir
        vars:
          OUTPUT_BASE: "{{.CURRENT_RENDERED}}"
      # Render main branch using git show (worktree-safe)
      - mkdir -p {{.MAIN_RENDERED}}
      - task: render-clusters-from-ref
        vars:
          GIT_REF: main
          OUTPUT_BASE: "{{.MAIN_RENDERED}}"
      # Run dyff for each cluster (compare main vs current to show changes FROM main TO current)
      - for: { var: CLUSTERS }
        cmd: |
          echo "=== Cluster: {{.ITEM}} ==="
          if [ -f "{{.MAIN_RENDERED}}/{{.ITEM}}/kustomize.yaml" ] && [ -f "{{.CURRENT_RENDERED}}/{{.ITEM}}/kustomize.yaml" ]; then
            dyff between --color on --omit-header "{{.MAIN_RENDERED}}/{{.ITEM}}/kustomize.yaml" "{{.CURRENT_RENDERED}}/{{.ITEM}}/kustomize.yaml" || true
          elif [ -f "{{.CURRENT_RENDERED}}/{{.ITEM}}/kustomize.yaml" ]; then
            echo "New cluster (not in main)"
          elif [ -f "{{.MAIN_RENDERED}}/{{.ITEM}}/kustomize.yaml" ]; then
            echo "Cluster removed"
          fi
          echo ""
    preconditions:
      - which dyff
      - which kustomize
      - which git

  render-clusters-from-ref:
    desc: Renders all clusters from a specific git ref (worktree-safe)
    internal: true
    silent: true
    requires:
      vars: [GIT_REF, OUTPUT_BASE]
    vars:
      CLUSTERS:
        sh: "ls -1 {{.CLUSTER_DIR}}"
      TEMP_DIR:
        sh: "mktemp -d"
    cmds:
      - defer: rm -rf {{.TEMP_DIR}}
      # Extract kubernetes/ directory from git ref to temp location
      - mkdir -p {{.TEMP_DIR}}/kubernetes
      - git archive {{.GIT_REF}} kubernetes | tar -x -C {{.TEMP_DIR}}
      # Render each cluster from the extracted files
      - for: { var: CLUSTERS }
        cmd: |
          cluster_name="{{.ITEM}}"
          kustomization="{{.TEMP_DIR}}/kubernetes/clusters/$cluster_name"
          output_dir="{{.OUTPUT_BASE}}/$cluster_name"
          mkdir -p "$output_dir"
          if [ -d "$kustomization" ] && [ -f "$kustomization/kustomization.yaml" ]; then
            kustomize build "$kustomization" > "$output_dir/kustomize.yaml" 2> "$output_dir/kustomize_errors.log" || true
          else
            echo "Cluster $cluster_name has no kustomization.yaml in {{.GIT_REF}}" > "$output_dir/kustomize_errors.log"
          fi

  render-clusters-to-dir:
    desc: Renders all clusters to a specific directory
    internal: true
    silent: true
    requires:
      vars: [OUTPUT_BASE]
    vars:
      CLUSTERS:
        sh: "ls -1 {{.CLUSTER_DIR}}"
    cmds:
      - for: { var: CLUSTERS }
        task: render-cluster-to-dir
        vars:
          CLUSTER: "{{.ITEM}}"
          OUTPUT_BASE: "{{.OUTPUT_BASE}}"

  render-cluster-to-dir:
    desc: Renders a cluster to a specific directory
    internal: true
    silent: true
    requires:
      vars: [CLUSTER, OUTPUT_BASE]
    vars:
      OUTPUT_DIR: "{{.OUTPUT_BASE}}/{{.CLUSTER}}"
      RENDERED: "{{.OUTPUT_DIR}}/kustomize.yaml"
      ERRORS: "{{.OUTPUT_DIR}}/kustomize_errors.log"
      KUSTOMIZATION: "{{.CLUSTER_DIR}}/{{.CLUSTER}}"
    cmds:
      - mkdir -p {{.OUTPUT_DIR}}
      - cmd: |
          if [ -d "{{.KUSTOMIZATION}}" ] && [ -f "{{.KUSTOMIZATION}}/kustomization.yaml" ]; then
            kustomize build "{{.KUSTOMIZATION}}" > "{{.RENDERED}}" 2> "{{.ERRORS}}"
          else
            echo "Cluster {{.CLUSTER}} has no kustomization.yaml, skipping" > "{{.ERRORS}}"
          fi
        ignore_error: true
    preconditions:
      - which kustomize
  render:
    desc: Renders all manifests.
    silent: true
    cmds:
      - task: render-clusters
      - task: render-helm-releases
      - echo "✅ All manifests rendered."

  render-clusters:
    desc: Renders all clusters.
    silent: true
    vars:
      CLUSTERS:
        sh: "ls -1 {{.CLUSTER_DIR}}"
    cmds:
      - for: { var: CLUSTERS }
        task: render-cluster-{{.ITEM}}
      - echo "✅ Clusters rendered."

  render-cluster-*:
    desc: Renders the cluster.
    label: render-cluster-{{.CLUSTER}}
    silent: true
    vars:
      CLUSTER: "{{ index .MATCH 0 }}"
    cmds:
      - task: kustomize-render
        vars:
          KUSTOMIZATION: "{{.CLUSTER_DIR}}/{{.CLUSTER}}"
    preconditions:
      - which kustomize
      - test -d "{{.CLUSTER_DIR}}/{{.CLUSTER}}"
      - test -f "{{.CLUSTER_DIR}}/{{.CLUSTER}}/kustomization.yaml"

  render-helm-releases:
    desc: Renders all Helm releases.
    silent: true
    vars:
      HELM_RELEASES:
        sh: "ls -1 {{.MANIFESTS_DIR}}/helm-release"
    cmds:
      - for: { var: HELM_RELEASES }
        task: render-helm-release-{{.ITEM}}
      - echo "✅ Helm releases rendered."
      - for: { var: HELM_RELEASES }
        task: kustomize-render
        vars:
          KUSTOMIZATION: "{{.MANIFESTS_DIR}}/helm-release/{{.ITEM}}"
      - echo "✅ Helm releases kustomize rendered."

  render-helm-release-*:
    desc: Renders the Helm release.
    internal: true
    silent: true
    label: render-helm-release-{{.RELEASE}}
    vars:
      RELEASE: "{{ index .MATCH 0 }}"
      RELEASE_DIR: "{{.MANIFESTS_DIR}}/helm-release/{{.RELEASE}}"
      RELATIVE_RELEASE_DIR: kubernetes/manifests/helm-release/{{.RELEASE}}
      VALUES_FILE: "{{.RELEASE_DIR}}/values.yaml"
      CLUSTER_CONTEXT: '{{.CLUSTER_CONTEXT| default "dev"}}'
      CLUSTER_DIR: "{{.CLUSTER_DIR}}/{{.CLUSTER_CONTEXT}}"
      OUTPUT_DIR: "{{.RELEASE_DIR}}/.rendered"
      ERRORS: "{{.OUTPUT_DIR}}/helm_errors.log"
    dotenv: ["{{.CLUSTER_DIR}}/generated-cluster-vars.env"]
    env:
      HELM_CHART_VERSION:
        sh: 'cat $(grep -rl "path: {{.RELATIVE_RELEASE_DIR}}" "{{.CLUSTER_DIR}}" | grep -v "kustomize.yaml") | yq "select(.metadata.name == \"{{.RELEASE}}\") | .spec.postBuild.substitute.HELM_CHART_VERSION"'
    cmds:
      - defer: '[ ! -s {{.ERRORS}} ] && echo "✅ {{.RELEASE_DIR}} >> {{.OUTPUT_DIR}}" || echo "❌ {{.RELEASE_DIR}} >> {{.ERRORS}}"'
      - defer: sed -i '' '/Pulled:/d;/Digest:/d' "{{.ERRORS}}"
      - cmd: echo {{.RELATIVE_RELEASE_DIR}} "{{.CLUSTER_DIR}}"
      - cmd: rm -rf "{{.OUTPUT_DIR}}/{{.RELEASE}}"
        ignore_error: true
      - cmd: '{{.KUBERNETES_RESOURCES_DIR}}/template-helm-release.sh "{{.RELEASE_DIR}}" "{{.VALUES_FILE}}" "{{.OUTPUT_DIR}}" 2> "{{.ERRORS}}"'
    preconditions:
      - which kustomize
      - which helm
      - which flux
      - which yq
      - test -d "{{.MANIFESTS_DIR}}/helm-release/{{.RELEASE}}"
      - test -f "{{.MANIFESTS_DIR}}/helm-release/{{.RELEASE}}/kustomization.yaml"
      - test -d "{{.CLUSTER_DIR}}"
      - test -f "{{.CLUSTER_DIR}}/generated-cluster-vars.env"
      - test -f "{{.VALUES_FILE}}"
      - mkdir -p {{.OUTPUT_DIR}}
      - touch {{.ERRORS}}
    sources:
      - "{{.RELEASE_DIR}}/**/*.yaml"
      - "{{.MANIFESTS_DIR}}/common/resources/helm-release/**/*.yaml"
    generates:
      - "{{.OUTPUT_DIR}}/**/*.yaml"
      - "{{.ERRORS}}"

  kustomize-render:
    desc: Validates the kustomization.
    internal: true
    silent: true
    label: kustomize-render-{{.KUSTOMIZATION}}
    requires:
      vars: [KUSTOMIZATION]
    vars:
      OUTPUT_DIR: "{{.KUSTOMIZATION}}/.rendered"
      RENDERED: "{{.OUTPUT_DIR}}/kustomize.yaml"
      ERRORS: "{{.OUTPUT_DIR}}/kustomize_errors.log"
    cmds:
      - defer: '[ ! -s {{.ERRORS}} ] && echo "✅ {{.KUSTOMIZATION}} >> {{.RENDERED}}" || echo "❌ {{.KUSTOMIZATION}} >> {{.ERRORS}}"'
      - cmd: rm "{{.RENDERED}}" "{{.ERRORS}}"
        ignore_error: true
      - cmd: kustomize build "{{.KUSTOMIZATION}}" > "{{.RENDERED}}" 2> "{{.ERRORS}}"
    #  - cmd: kubectl apply --dry-run=client -f "{{.RENDERED}}" > /dev/null 2>> "{{.ERRORS}}"
    preconditions:
      - which kustomize
      - test -d {{.KUSTOMIZATION}}
      - mkdir -p {{.OUTPUT_DIR}}
      - touch {{.ERRORS}}
      - touch {{.RENDERED}}
    sources:
      - "{{.KUSTOMIZATION}}/**/*.yaml"
      - "{{.MANIFESTS_DIR}}/**/*.yaml"
    generates:
      - "{{.RENDERED}}"
      - "{{.ERRORS}}"
