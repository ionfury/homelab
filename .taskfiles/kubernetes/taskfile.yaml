---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]

vars:
  CHARTS_DIR: "{{.ROOT_DIR}}/kubernetes/platform/charts"
  HELM_CHARTS_FILE: "{{.ROOT_DIR}}/kubernetes/platform/helm-charts.yaml"
  CLUSTER_VARS: "{{.ROOT_DIR}}/kubernetes/clusters/dev/.cluster-vars.env"
  MANIFESTS_DIR: "/tmp/homelab-manifests"
  PLATFORM_DIR: "{{.ROOT_DIR}}/kubernetes/platform"
  RESOURCESETS: "namespaces.yaml helm-charts.yaml config.yaml"
  STATIC_PROVIDER: "{{.PLATFORM_DIR}}/.static-provider.yaml"
  EXPANDED_DIR: "/tmp/homelab-expanded"
  DEV_KUBECONFIG: "~/.kube/dev.yaml"
  # Test variables for Flux substitution (used by helm templating)
  TEST_CLUSTER_NAME: ci-test
  TEST_POD_SUBNET: "10.244.0.0/16"
  TEST_INTERNAL_DOMAIN: internal.ci.example.com
  TEST_EXTERNAL_DOMAIN: external.ci.example.com
  TEST_REPLICA_COUNT: "1"
  TEST_GARAGE_DATA_SIZE: "10Gi"
  TEST_GARAGE_META_SIZE: "1Gi"
  TEST_LOKI_SIZE: "10Gi"
  TEST_PROMETHEUS_SIZE: "10Gi"

tasks:
  # =============================================================================
  # User-Facing Tasks
  # =============================================================================

  validate:
    desc: Full Kubernetes validation (lint, ResourceSets, all charts, kubeconform)
    cmds:
      - task: _lint
      - task: _expand-resourcesets
      - task: _build-manifests
      - task: _substitute-vars
      - task: _template-all-charts
      - task: _validate-kubeconform

  dry-run-dev:
    desc: Server-side dry-run against dev cluster
    deps: [validate]
    cmds:
      - |
        echo "Running server-side dry-run against dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Dry-run: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply --dry-run=server -f "$manifest"
        done
        echo ""
        echo "Server-side dry-run completed successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  apply-dev:
    desc: Apply manifests to dev cluster (REQUIRES CONFIRMATION)
    deps: [validate]
    prompt: This will apply manifests to the dev cluster. Continue?
    cmds:
      - |
        echo "Applying to dev cluster..."
        echo ""
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          echo "Applying: $(basename $manifest)"
          KUBECONFIG={{.DEV_KUBECONFIG}} kubectl apply -f "$manifest"
        done
        echo ""
        echo "Applied to dev cluster successfully"
    preconditions:
      - which kubectl
      - test -f {{.DEV_KUBECONFIG}}
      - test -d {{.EXPANDED_DIR}}/resourcesets

  # =============================================================================
  # Internal Tasks (hidden from task --list)
  # =============================================================================

  _lint:
    internal: true
    cmds:
      - yamllint --strict kubernetes/
      - yamllint --strict .github/workflows/
    preconditions:
      - which yamllint

  _build-manifests:
    internal: true
    env:
      MANIFESTS_DIR: "{{.MANIFESTS_DIR}}"
      PLATFORM_DIR: "{{.PLATFORM_DIR}}"
    cmds:
      - rm -rf {{.MANIFESTS_DIR}} && mkdir -p {{.MANIFESTS_DIR}}
      - "{{.TASKFILE_DIR}}/scripts/build-manifests.sh"
    preconditions:
      - which kustomize

  _substitute-vars:
    internal: true
    deps: [_build-manifests, _expand-resourcesets]
    env:
      CLUSTER_VARS: "{{.CLUSTER_VARS}}"
      MANIFESTS_DIR: "{{.MANIFESTS_DIR}}"
    cmds:
      - "{{.TASKFILE_DIR}}/scripts/substitute-vars.sh"
      # Also substitute vars in expanded ResourceSets for validation
      - |
        set -a && source "{{.CLUSTER_VARS}}" && set +a
        for manifest in {{.EXPANDED_DIR}}/resourcesets/*.yaml; do
          envsubst < "$manifest" > "${manifest}.tmp"
          mv "${manifest}.tmp" "$manifest"
        done
    preconditions:
      - which envsubst yq

  _expand-resourcesets:
    internal: true
    cmds:
      - rm -rf {{.EXPANDED_DIR}}/resourcesets && mkdir -p {{.EXPANDED_DIR}}/resourcesets
      - |
        for rset in {{.RESOURCESETS}}; do
          echo "Expanding ResourceSet: $rset"
          flux-operator build rset \
            -f "{{.PLATFORM_DIR}}/$rset" \
            --inputs-from-provider "{{.STATIC_PROVIDER}}" \
            > "{{.EXPANDED_DIR}}/resourcesets/${rset}"
        done
    preconditions:
      - which flux-operator
      - test -f {{.STATIC_PROVIDER}}

  _template-all-charts:
    internal: true
    deps: [_expand-resourcesets]
    env:
      CHARTS_DIR: "{{.CHARTS_DIR}}"
      HELM_CHARTS_FILE: "{{.HELM_CHARTS_FILE}}"
      EXPANDED_DIR: "{{.EXPANDED_DIR}}"
      cluster_name: "{{.TEST_CLUSTER_NAME}}"
      cluster_pod_subnet: "{{.TEST_POD_SUBNET}}"
      internal_domain: "{{.TEST_INTERNAL_DOMAIN}}"
      external_domain: "{{.TEST_EXTERNAL_DOMAIN}}"
      default_replica_count: "{{.TEST_REPLICA_COUNT}}"
      garage_data_volume_size: "{{.TEST_GARAGE_DATA_SIZE}}"
      garage_meta_volume_size: "{{.TEST_GARAGE_META_SIZE}}"
      loki_volume_size: "{{.TEST_LOKI_SIZE}}"
      prometheus_volume_size: "{{.TEST_PROMETHEUS_SIZE}}"
    cmds:
      - mkdir -p {{.EXPANDED_DIR}}/helm
      - "{{.TASKFILE_DIR}}/scripts/template-all-charts.sh"
    preconditions:
      - which helm yq jq envsubst

  _validate-kubeconform:
    internal: true
    deps: [_template-all-charts, _substitute-vars]
    vars:
      KUBECONFORM_ARGS: >-
        -schema-location default
        -schema-location 'https://kubernetes-schemas.pages.dev/{{ "{{.Group}}" }}/{{ "{{.ResourceKind}}" }}_{{ "{{.ResourceAPIVersion}}" }}.json'
        -ignore-missing-schemas
        -summary
        -output text
    cmds:
      - echo "Validating expanded ResourceSets..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.EXPANDED_DIR}}/resourcesets/*.yaml
      - echo ""
      - echo "Validating templated Helm charts..."
      - kubeconform {{.KUBECONFORM_ARGS}} {{.EXPANDED_DIR}}/helm/*.yaml
      - echo ""
      - echo "Validating kustomize manifests..."
      - kubeconform {{.KUBECONFORM_ARGS}} -skip ResourceSet {{.MANIFESTS_DIR}}/*.yaml
    preconditions:
      - which kubeconform
      - test -d {{.EXPANDED_DIR}}/resourcesets
      - test -d {{.EXPANDED_DIR}}/helm
