---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  INFRASTRUCTURE_DIR: "{{.ROOT_DIR}}/infrastructure"

env:
  AWS_REGION: us-east-2
  AWS_PROFILE: terragrunt
  TG_NON_INTERACTIVE: "true"

tasks:
  use:
    desc: Uses tgenv to set up the Terragrunt environment, installing if needed.
    cmds:
      - tgenv install
      - tgenv use
    preconditions:
      - which tgenv

  list:
    desc: Lists all terragrunt stacks.
    cmds:
      - "find {{.INFRASTRUCTURE_DIR}}/stacks -mindepth 1 -maxdepth 1 -type d | sort | xargs -n1 basename"

  plan-*:
    desc: Plans a specific terragrunt stack.
    deps: [use, fmt]
    vars:
      STACK: "{{index .MATCH 0}}"
    label: plan-{{.STACK}}
    cmds:
      - terragrunt stack run init --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}} -- -upgrade
      - terragrunt stack run plan --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"

  apply-*:
    desc: Applies a specific terragrunt stack.
    deps: [use, fmt]
    vars:
      STACK: "{{index .MATCH 0}}"
    label: apply-{{.STACK}}
    cmds:
      - terragrunt stack run init --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}} -- -upgrade
      - terragrunt stack run apply --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"

  fmt:
    desc: Formats Open Tofu & Terragrunt files.
    cmds:
      - task: tofu-fmt
      - task: tg-fmt

  tofu-fmt:
    desc: Formats Open Tofu files.
    internal: true
    cmds:
      - tofu fmt -recursive
    preconditions:
      - which tofu
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.tf"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.tf"

  tg-fmt:
    desc: Formats Open Tofu & Terragrunt files.
    internal: true
    cmds:
      - terragrunt hcl fmt
    preconditions:
      - which tofu terragrunt
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.hcl"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.hcl"

  gen-*:
    desc: Generates a specific terragrunt stack.
    deps: [use, fmt]
    vars:
      STACK: "{{index .MATCH 0}}"
    label: gen-{{.STACK}}
    cmds:
      - terragrunt stack generate --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}/**"
      - "{{.INFRASTRUCTURE_DIR}}/modules/**"
      - "{{.INFRASTRUCTURE_DIR}}/units/**"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}/.terragrunt-stack/**"

  clean-*:
    desc: Cleans a specific terragrunt stack.
    deps: [use, fmt]
    vars:
      STACK: "{{index .MATCH 0}}"
    label: clean-{{.STACK}}
    cmds:
      - terragrunt stack clean --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"

  preflight-*:
    desc: Verify nodes are in maintenance mode before applying a stack.
    vars:
      STACK: "{{index .MATCH 0}}"
    label: preflight-{{.STACK}}
    cmds:
      - |
        echo "Checking nodes for {{.STACK}} cluster..."
        failed=0
        for node in $(grep -B1 'cluster = "{{.STACK}}"' {{.INFRASTRUCTURE_DIR}}/inventory.hcl | grep -oE '[a-z]+[0-9]+\s*=' | sed 's/\s*=//'); do
          result=$(task talos:maint-${node} 2>&1)
          if echo "$result" | grep -q "yes"; then
            echo "✅ ${node} is in maintenance mode"
          else
            echo "❌ ${node} is NOT in maintenance mode"
            failed=1
          fi
        done
        if [ $failed -eq 1 ]; then
          echo ""
          echo "Some nodes are not ready. Run 'task talos:maint' to see full status."
          exit 1
        fi
        echo ""
        echo "All nodes ready for {{.STACK}} cluster apply."
    preconditions:
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"

  status-*:
    desc: Show power and maintenance status of nodes in a cluster.
    vars:
      STACK: "{{index .MATCH 0}}"
    label: status-{{.STACK}}
    cmds:
      - |
        echo "=== {{.STACK}} cluster status ==="
        echo ""
        # Extract node names for this cluster from inventory
        nodes=$(grep -B1 'cluster = "{{.STACK}}"' {{.INFRASTRUCTURE_DIR}}/inventory.hcl | grep -oE '[a-z]+[0-9]+\s*=' | sed 's/\s*=//' | sort -u)

        echo "Nodes: $(echo $nodes | tr '\n' ' ')"
        echo ""

        echo "Power Status:"
        for node in $nodes; do
          result=$(task inv:status-${node} 2>&1 | grep -i "power" | head -1 || echo "unknown")
          echo "  ${node}: ${result}"
        done

        echo ""
        echo "Maintenance Mode:"
        for node in $nodes; do
          result=$(task talos:maint-${node} 2>&1)
          if echo "$result" | grep -q "yes"; then
            echo "  ${node}: maintenance"
          elif echo "$result" | grep -q "no-ip"; then
            echo "  ${node}: no-ip (powered off?)"
          elif echo "$result" | grep -q "no"; then
            echo "  ${node}: running"
          else
            echo "  ${node}: unknown"
          fi
        done
    preconditions:
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"

  validate-*:
    desc: Validates a specific terragrunt stack.
    deps: [use, fmt]
    vars:
      STACK: "{{index .MATCH 0}}"
    label: validate-{{.STACK}}
    cmds:
      - terragrunt stack run init --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}} -- -upgrade
      - terragrunt stack run validate --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}/**"
      - "{{.INFRASTRUCTURE_DIR}}/modules/**"
      - "{{.INFRASTRUCTURE_DIR}}/units/**"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}/.terragrunt-stack/**"

  test-*:
    desc: Runs tests for a specific module.
    deps: [fmt]
    vars:
      MODULE: "{{index .MATCH 0}}"
    label: test-{{.MODULE}}
    dir: "{{.INFRASTRUCTURE_DIR}}/modules/{{.MODULE}}"
    cmds:
      - tofu init -upgrade
      - tofu test
    preconditions:
      - which tofu
      - test -d "{{.INFRASTRUCTURE_DIR}}/modules/{{.MODULE}}"
      - test -d "{{.INFRASTRUCTURE_DIR}}/modules/{{.MODULE}}/tests"

  destroy-*:
    desc: Destroys a specific terragrunt stack.
    deps: [use, fmt]
    prompt: This will destroy the cluster.  Are you sure you want to continue? (yes/no)
    vars:
      STACK: "{{index .MATCH 0}}"
      WORKING_DIR: "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}/.terragrunt-stack"
      BOOTSTRAP_DIR: "{{.WORKING_DIR}}/bootstrap"
    label: destroy-{{.STACK}}
    cmds:
      - terragrunt stack run init --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}} -- -upgrade
      - terragrunt --working-dir {{.BOOTSTRAP_DIR}} state list 2>/dev/null | grep -E '^(helm_release|kubernetes)' | xargs -r -I {} terragrunt --working-dir {{.BOOTSTRAP_DIR}} state rm {} || true
      - terragrunt stack run destroy --working-dir {{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}
    preconditions:
      - which terragrunt
      - test -d "{{.INFRASTRUCTURE_DIR}}/stacks/{{.STACK}}"
