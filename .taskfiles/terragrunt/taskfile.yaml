---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  INFRASTRUCTURE_DIR: "{{.ROOT_DIR}}/infrastructure"

tasks:
  run:
    desc: Runs terragrunt stacks.
    cmds:
      - task: clean
      - task: fmt
      - task: gen
      - task: validate
  fmt:
    desc: Formats Open Tofu & Terragrunt files.
    cmds:
      - task: tofu-fmt
      - task: tg-fmt

  tofu-fmt:
    desc: Formats Open Tofu files.
    internal: true
    cmds:
      - tofu fmt -recursive
    preconditions:
      - which tofu
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.tf"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.tf"

  tg-fmt:
    desc: Formats Open Tofu & Terragrunt files.
    internal: true
    cmds:
      - terragrunt hcl fmt
    preconditions:
      - which tofu terragrunt
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.hcl"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.hcl"

  gen:
    desc: Generates terragrunt stacks.
    cmds:
      - terragrunt stack generate
    preconditions:
      - which terragrunt
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/*.hcl"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/.terragrunt-stack/**"

  clean:
    desc: Cleans generated terragrunt stacks.
    cmds:
      - terragrunt stack clean
    preconditions:
      - which terragrunt

  validate:
    desc: Validates terragrunt stacks.
    cmds:
      - terragrunt stack run validate
    preconditions:
      - which terragrunt
    sources:
      - "{{.INFRASTRUCTURE_DIR}}/**/.terragrunt-stack/**"
    generates:
      - "{{.INFRASTRUCTURE_DIR}}/**/.terragrunt-stack/**"
