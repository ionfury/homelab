namespace: istio-system
namePrefix: istiod-

components:
  - ../../../../manifests/components/namespace
  - ../../../../manifests/components/helm

patches:
  - target:
      kind: HelmRelease
      name: helm-release
    patch: |
      - op: replace
        path: /spec/chart/spec/chart
        value: istiod
      - op: replace
        path: /spec/chart/spec/version
        value: 1.16.1
      - op: add
        path: /spec/dependsOn
        value:
          - name: cert-manager
            namespace: cert-manager
          - name: istio-csr-helm-release
            namespace: cert-manager
      - op: add
        path: /spec/postRenderers
        value:
          - kustomize:
              patchesJson6902:
                - target:
                    kind: Deployment
                    name: istiod
                    namespace: istio-system
                  patch:
                    - op: add
                      path: /spec/template/spec/containers/0/args/-
                      value: "--tlsCertFile=/var/run/secrets/istiod/tls/tls.crt"
                    - op: add
                      path: /spec/template/spec/containers/0/args/-
                      value: "--tlsKeyFile=/var/run/secrets/istiod/tls/tls.key"
                    - op: add
                      path: /spec/template/spec/containers/0/args/-
                      value: "--caCertFile=/var/run/secrets/istiod/caroot-cert.pem"
  - target:
      kind: HelmRepository
      name: helm-repository
    patch: |
      - op: replace
        path: /spec/url
        value: https://istio-release.storage.googleapis.com/charts

configMapGenerator:
  - name: values
    behavior: replace
    files:
      - values.yaml

secretGenerator:
  - name: secret-values
    behavior: replace
    files:
      - values.yaml=secret-values.encrypted.yaml